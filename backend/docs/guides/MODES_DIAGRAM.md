# 🔄 Схема работы системы управления режимами

## 📊 Общая архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                    Запуск приложения                         │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              Чтение файла .env.mode                          │
│              (содержит: "dev" или "prod")                    │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
            ┌───────────────┴───────────────┐
            │                               │
            ▼                               ▼
    ┌───────────────┐               ┌───────────────┐
    │   MODE = dev  │               │  MODE = prod  │
    └───────────────┘               └───────────────┘
            │                               │
            ▼                               ▼
    ┌───────────────┐               ┌───────────────┐
    │  Загрузка     │               │  Загрузка     │
    │  .env.local   │               │  .env         │
    └───────────────┘               └───────────────┘
            │                               │
            ▼                               ▼
    ┌───────────────┐               ┌───────────────┐
    │  Валидация    │               │  Валидация    │
    │  переменных   │               │  переменных   │
    └───────────────┘               └───────────────┘
            │                               │
            ▼                               ▼
    ┌───────────────┐               ┌───────────────┐
    │  Экспорт      │               │  Экспорт      │
    │  config       │               │  config       │
    │  IS_DEV=true  │               │  IS_PROD=true │
    └───────────────┘               └───────────────┘
```

## 🔄 Процесс переключения режимов

```
┌─────────────────────────────────────────────────────────────┐
│           Команда: npm run mode:dev или mode:prod           │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              scripts/switch-mode.ts                          │
│              (утилита переключения)                          │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│           Запись нового значения в .env.mode                 │
│           ("dev" или "prod")                                 │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│           Вывод информации о новом режиме                    │
│           - Какой файл используется                          │
│           - Какие команды для запуска                        │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│           Следующий запуск приложения                        │
│           будет использовать новый режим                     │
└─────────────────────────────────────────────────────────────┘
```

## 📁 Структура файлов конфигурации

```
┌─────────────────────────────────────────────────────────────┐
│                    .env.mode                                 │
│                    (1 строка)                                │
├─────────────────────────────────────────────────────────────┤
│                    dev                                       │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    .env.local                                │
│                    (режим разработки)                        │
├─────────────────────────────────────────────────────────────┤
│  NODE_ENV=development                                       │
│  DATABASE_URL=postgresql://...@localhost:5432/...           │
│  REDIS_HOST=localhost                                       │
│  REDIS_PORT=6379                                            │
│  PORT=3001                                                  │
│  HOST=localhost                                              │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    .env                                      │
│                    (продакшен режим)                         │
├─────────────────────────────────────────────────────────────┤
│  NODE_ENV=production                                        │
│  DATABASE_URL=postgresql://...@postgres:5432/...            │
│  REDIS_HOST=redis                                           │
│  REDIS_PORT=6379                                            │
│  PORT=3000                                                  │
│  HOST=0.0.0.0                                               │
└─────────────────────────────────────────────────────────────┘
```

## 🔄 Поток данных в приложении

```
┌─────────────────────────────────────────────────────────────┐
│              Приложение запускается                          │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  1. Импорт конфигурации:                                     │
│     import { config, IS_DEV } from './config'                │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  2. config.ts читает .env.mode                               │
│     определяет режим (dev/prod)                              │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  3. Загружает соответствующий .env файл                      │
│     через dotenv.config({ path: envFile })                   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  4. Валидирует обязательные переменные                       │
│     (DATABASE_URL, REDIS_HOST, REDIS_PORT)                   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  5. Создает объект конфигурации с типами                     │
│     и экспортует его                                         │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  6. Приложение использует настройки:                         │
│     - Подключение к БД                                       │
│     - Подключение к Redis                                    │
│     - Порт сервера                                           │
│     - Уровень логирования                                    │
└─────────────────────────────────────────────────────────────┘
```

## 🎯 Пример использования в коде

```typescript
// src/api/server.ts
import { config, IS_DEV } from '../shared/config/config';

// Автоматически использует правильные настройки
const fastify = Fastify({
  logger: {
    level: IS_DEV ? 'debug' : 'info',  // ← Разный уровень в зависимости от режима
    prettyPrint: IS_DEV,                // ← Pretty print только в dev
  },
});

// Подключение к Redis
const redis = new Redis({
  host: config.redis.host,    // ← localhost в dev, redis в prod
  port: config.redis.port,
  password: config.redis.password,
});

// Запуск сервера
fastify.listen({
  port: config.api.port,      // ← 3001 в dev, 3000 в prod
  host: config.api.host,      // ← localhost в dev, 0.0.0.0 в prod
});
```

## 🔧 Команды и их эффект

```
┌─────────────────────────┬─────────────────────────────────────┐
│   Команда               │   Что происходит                    │
├─────────────────────────┼─────────────────────────────────────┤
│  npm run init           │  1. Создает .env.mode (dev)         │
│                         │  2. Создает .env.local из шаблона   │
│                         │  3. Проверяет зависимости           │
│                         │  4. Устанавливает пакеты            │
├─────────────────────────┼─────────────────────────────────────┤
│  npm run mode           │  1. Читает .env.mode                │
│                         │  2. Показывает текущий режим        │
│                         │  3. Показывает конфигурацию         │
├─────────────────────────┼─────────────────────────────────────┤
│  npm run mode:dev       │  1. Записывает "dev" в .env.mode    │
│                         │  2. Показывает инфо о режиме dev    │
│                         │  3. Следующий запуск - в режиме dev │
├─────────────────────────┼─────────────────────────────────────┤
│  npm run mode:prod      │  1. Записывает "prod" в .env.mode   │
│                         │  2. Показывает инфо о режиме prod   │
│                         │  3. Следующий запуск - в режиме prod│
└─────────────────────────┴─────────────────────────────────────┘
```

## 🎨 Визуализация режимов

```
╔═════════════════════════════════════════════════════════════╗
║                    🛠️  DEVELOPMENT MODE                     ║
╠═════════════════════════════════════════════════════════════╣
║  Файл конфигурации:    .env.local                           ║
║  База данных:          localhost:5432                       ║
║  Redis:                localhost:6379                       ║
║  API порт:             3001                                 ║
║  API хост:             localhost                            ║
║  Логирование:          Расширенное (debug)                  ║
║  Hot reload:           ✅ Да                                ║
║  Запуск:               npm run dev:api                      ║
║                        npm run dev:worker                   ║
╚═════════════════════════════════════════════════════════════╝

╔═════════════════════════════════════════════════════════════╗
║                    🚀  PRODUCTION MODE                      ║
╠═════════════════════════════════════════════════════════════╣
║  Файл конфигурации:    .env                                 ║
║  База данных:          контейнер postgres                   ║
║  Redis:                контейнер redis                      ║
║  API порт:             3000                                 ║
║  API хост:             0.0.0.0                              ║
║  Логирование:          Минимальное (info)                   ║
║  Hot reload:           ❌ Нет                               ║
║  Запуск:               docker-compose up -d                 ║
╚═════════════════════════════════════════════════════════════╝
```

## 📊 Диаграмма последовательности

```
Клиент                    CLI                    Файловая система
  │                        │                              │
  │   npm run mode:dev     │                              │
  ├───────────────────────>│                              │
  │                        │                              │
  │                        │   Записать "dev"             │
  │                        ├─────────────────────────────>│
  │                        │                              │
  │                        │   Чтение .env.local          │
  │                        │<─────────────────────────────┤
  │                        │                              │
  │   Вывод информации     │                              │
  │<───────────────────────┤                              │
  │                        │                              │
  │                        │                              │
  │   npm run dev:api      │                              │
  ├───────────────────────>│                              │
  │                        │                              │
  │                        │   Чтение .env.mode           │
  │                        ├─────────────────────────────>│
  │                        │                              │
  │                        │   Загрузка .env.local        │
  │                        ├─────────────────────────────>│
  │                        │                              │
  │                        │   Валидация                  │
  │                        │                              │
  │                        │   Запуск сервера             │
  │                        │                              │
  │   Сервер запущен       │                              │
  │<───────────────────────┤                              │
```

---

**Дата создания:** 29 января 2026  
**Версия:** 1.0.0
