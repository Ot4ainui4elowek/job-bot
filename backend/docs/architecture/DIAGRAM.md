# 📊 Визуальная диаграмма работы системы

## Поток данных

```
┌──────────────────────────────────────────────────────────────────┐
│                         ПОЛЬЗОВАТЕЛЬ                              │
│                   GET /api/vacancies?keywords=X                   │
└───────────────────────────────┬──────────────────────────────────┘
                                │
                                ↓
┌──────────────────────────────────────────────────────────────────┐
│                          API SERVER                               │
│                      (Fastify + Routes)                           │
└───────────────────────────────┬──────────────────────────────────┘
                                │
                                ↓
┌──────────────────────────────────────────────────────────────────┐
│                      VACANCY MANAGER                              │
│                   (Умная логика поиска)                           │
│                                                                   │
│  1. Проверяет ParseLog: WHERE searchQuery = X                    │
│  2. Решает: парсить или взять из БД                              │
│  3. Возвращает результат                                          │
└───────────────────────────────┬──────────────────────────────────┘
                                │
                ┌───────────────┼───────────────┐
                │               │               │
                ↓               ↓               ↓
        ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
        │ ПАРСИНГ     │ │ БАЗА ДАННЫХ │ │ ЛОГИРОВАНИЕ │
        │             │ │             │ │             │
        │ - rabota.md │ │ - Vacancy   │ │ - ParseLog  │
        │ - 999.md    │ │ - поиск     │ │ - searchQuery│
        │ - makler.md │ │ - фильтры   │ │ - duration  │
        └─────────────┘ └─────────────┘ └─────────────┘
```

---

## Логика принятия решений

```
┌─────────────────────────────────────────────────────────────┐
│ Запрос: GET /api/vacancies?keywords=developer               │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ↓
              ┌──────────────────────┐
              │ Проверка ParseLog    │
              │ WHERE searchQuery =  │
              │ "developer"          │
              └──────────┬───────────┘
                         │
         ┌───────────────┼───────────────┐
         │               │               │
   ЗАПИСЬ ЕСТЬ    ЗАПИСИ НЕТ     ЗАПИСЬ СТАРАЯ
   (< 12 часов)                  (> 12 часов)
         │               │               │
         ↓               ↓               ↓
   ┌──────────┐   ┌──────────┐   ┌──────────┐
   │  CACHE   │   │  FRESH   │   │  FRESH   │
   │          │   │          │   │          │
   │ Берем из │   │ Парсим   │   │ Парсим   │
   │ БД       │   │ СЕЙЧАС   │   │ СЕЙЧАС   │
   │          │   │          │   │          │
   │ Быстро   │   │ Все      │   │ Все      │
   │ <100ms   │   │ источники│   │ источники│
   └──────────┘   └──────────┘   └──────────┘
         │               │               │
         └───────────────┼───────────────┘
                         ↓
              ┌──────────────────────┐
              │ Возврат результата   │
              │ {                    │
              │   vacancies: [...],  │
              │   meta: {            │
              │     source: "cache"  │
              │     или "fresh"      │
              │   }                  │
              │ }                    │
              └──────────────────────┘
```

---

## Процесс парсинга

```
┌──────────────────────────────────────────────────────────────┐
│              ПАРСИНГ ЗАПУЩЕН (searchQuery=X)                 │
└────────────────────────┬─────────────────────────────────────┘
                         │
                         ↓
              ┌──────────────────────┐
              │ Параллельный запуск  │
              │ всех парсеров        │
              └──────────┬───────────┘
                         │
         ┌───────────────┼───────────────┐
         │               │               │
         ↓               ↓               ↓
   ┌──────────┐   ┌──────────┐   ┌──────────┐
   │ Rabota   │   │ 999.md   │   │ Makler   │
   │          │   │          │   │          │
   │ parse()  │   │ parse()  │   │ parse()  │
   │ 3 страницы   │ 3 страницы   │ 3 страницы
   └────┬─────┘   └────┬─────┘   └────┬─────┘
        │              │              │
        └──────────────┼──────────────┘
                       ↓
            ┌──────────────────────┐
            │ Сбор всех результатов│
            │ Promise.allSettled() │
            └──────────┬───────────┘
                       │
                       ↓
            ┌──────────────────────┐
            │ Сохранение в БД      │
            │ vacancyService       │
            │ .saveVacancies()     │
            └──────────┬───────────┘
                       │
                       ↓
            ┌──────────────────────┐
            │ Логирование          │
            │ ParseLog.create({    │
            │   source,            │
            │   searchQuery: X,    │
            │   vacanciesFound,    │
            │   vacanciesNew       │
            │ })                   │
            └──────────────────────┘
```

---

## Таймлайн работы

```
TIME →

0ms     Запрос от пользователя
        |
        ↓
10ms    VacancyManager.search()
        |
        ↓
50ms    Проверка ParseLog
        |
        ↓
        ┌─────────────┐  ┌──────────────┐
        │ CACHE путь  │  │ FRESH путь   │
        │ 100ms ✅    │  │ 5000ms       │
        └─────────────┘  │              │
                         │ 100ms  Парсинг rabota.md
                         │ 2000ms Парсинг 999.md
                         │ 1500ms Парсинг makler.md
                         │ 
                         │ 1000ms Сохранение в БД
                         │ 100ms  Логирование
                         │ 300ms  Фильтрация
                         └──────────────┘

        ↓
100ms   Ответ пользователю (cache)
или
5000ms  Ответ пользователю (fresh)
```

---

## Структура базы данных

```
┌────────────────────────────────────────────────────────┐
│                      VACANCY                           │
├────────────────────────────────────────────────────────┤
│ id              String (PK)                            │
│ title           String                                 │
│ company         String                                 │
│ description     Text                                   │
│ location        String                                 │
│ salaryMin       Int                                    │
│ salaryMax       Int                                    │
│ source          String (index)                         │
│ sourceId        String                                 │
│ sourceUrl       String                                 │
│ publishedAt     DateTime (index)                       │
│ createdAt       DateTime                               │
│ updatedAt       DateTime                               │
│                                                        │
│ UNIQUE: [source, sourceId]                            │
│ INDEX:  [source, publishedAt]                         │
└────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────┐
│                     PARSE_LOG                          │
├────────────────────────────────────────────────────────┤
│ id              String (PK)                            │
│ source          String                                 │
│ searchQuery     String ← ДОБАВЛЕНО                     │
│ status          String (success/error)                 │
│ vacanciesFound  Int                                    │
│ vacanciesNew    Int                                    │
│ duration        Int (ms)                               │
│ error           Text                                   │
│ createdAt       DateTime                               │
│                                                        │
│ INDEX: [source, searchQuery, createdAt] ← ОБНОВЛЕН    │
└────────────────────────────────────────────────────────┘
```

---

## Примеры запросов

### 1. Первый поиск (парсинг)
```bash
→ GET /api/vacancies?keywords=developer
← 200 OK (5000ms)
{
  "data": [...150 вакансий...],
  "meta": {
    "source": "fresh",      ← ЗАПУСТИЛИ ПАРСИНГ
    "total": 150,
    "lastUpdate": "2025-01-07T10:30:00Z",
    "parseReason": "Нет результатов по этому запросу"
  }
}

ParseLog:
| source     | searchQuery | status  | vacanciesFound | createdAt           |
|------------|-------------|---------|----------------|---------------------|
| rabota.md  | developer   | success | 100            | 2025-01-07 10:30:00 |
| 999.md     | developer   | success | 50             | 2025-01-07 10:30:02 |
```

### 2. Повторный поиск (кеш)
```bash
→ GET /api/vacancies?keywords=developer
← 200 OK (100ms) ← БЫСТРО!
{
  "data": [...150 вакансий...],
  "meta": {
    "source": "cache",      ← ИЗ БД
    "total": 150,
    "lastUpdate": "2025-01-07T10:30:00Z"
  }
}

Логи:
ℹ️  Запрос "developer" уже парсился недавно (rabota.md)
⏰ Последний парсинг: 07.01.2025, 10:30:00
```

### 3. Новый запрос (парсинг)
```bash
→ GET /api/vacancies?keywords=react
← 200 OK (4500ms)
{
  "data": [...80 вакансий...],
  "meta": {
    "source": "fresh",      ← НОВЫЙ ПАРСИНГ
    "total": 80,
    "parseReason": "Нет результатов по этому запросу"
  }
}

ParseLog:
| source     | searchQuery | status  | vacanciesFound | createdAt           |
|------------|-------------|---------|----------------|---------------------|
| rabota.md  | react       | success | 50             | 2025-01-07 10:35:00 |
| 999.md     | react       | success | 30             | 2025-01-07 10:35:01 |
```

---

## 🎯 Ключевые особенности

1. **Умная проверка** - по searchQuery, а не просто по источнику
2. **Параллельность** - все парсеры работают одновременно
3. **Кеширование** - не парсит повторно < 12 часов
4. **Логирование** - полная информация о каждом парсинге
5. **Быстрота** - кеш отвечает за 100мс, парсинг за 5 сек

**ВСЁ РАБОТАЕТ! ✅**
