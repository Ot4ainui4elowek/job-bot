# üê≥ –£–¥–æ–±–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Docker

# –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
.PHONY: help start stop restart logs build clean dev prod

help: ## –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É
	@echo "üê≥ Docker –∫–æ–º–∞–Ω–¥—ã –¥–ª—è Parsing –ø—Ä–æ–µ–∫—Ç–∞:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'

# ============================================
# –û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´
# ============================================

start: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
	@echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞..."
	docker-compose up -d
	@echo "‚úÖ –ü—Ä–æ–µ–∫—Ç –∑–∞–ø—É—â–µ–Ω!"
	@echo "üåê API: http://localhost:3000"

stop: ## –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
	@echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
	docker-compose down
	@echo "‚úÖ –ü—Ä–æ–µ–∫—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"

restart: ## –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
	@echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞..."
	docker-compose restart
	@echo "‚úÖ –ü—Ä–æ–µ–∫—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω!"

logs: ## –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏
	docker-compose logs -f

ps: ## –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
	docker-compose ps

# ============================================
# –°–ë–û–†–ö–ê
# ============================================

build: ## –°–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑—ã
	@echo "üî® –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤..."
	docker-compose build
	@echo "‚úÖ –û–±—Ä–∞–∑—ã —Å–æ–±—Ä–∞–Ω—ã!"

rebuild: ## –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑—ã (–±–µ–∑ –∫—ç—à–∞)
	@echo "üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤..."
	docker-compose build --no-cache
	@echo "‚úÖ –û–±—Ä–∞–∑—ã –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω—ã!"

# ============================================
# –†–ê–ó–†–ê–ë–û–¢–ö–ê
# ============================================

dev: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (—Å Adminer –∏ Redis UI)
	@echo "üöÄ –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏..."
	docker-compose --profile dev up -d
	@echo "‚úÖ –ü—Ä–æ–µ–∫—Ç –∑–∞–ø—É—â–µ–Ω –≤ dev —Ä–µ–∂–∏–º–µ!"
	@echo "üåê API:          http://localhost:3000"
	@echo "üóÑÔ∏è  Adminer:     http://localhost:8080"
	@echo "üìÆ Redis UI:     http://localhost:8081"

prod: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ production —Ä–µ–∂–∏–º–µ
	@echo "üöÄ –ó–∞–ø—É—Å–∫ –≤ production —Ä–µ–∂–∏–º–µ..."
	docker-compose up -d
	@echo "‚úÖ –ü—Ä–æ–µ–∫—Ç –∑–∞–ø—É—â–µ–Ω –≤ prod —Ä–µ–∂–∏–º–µ!"

# ============================================
# –ë–ê–ó–ê –î–ê–ù–ù–´–•
# ============================================

db-migrate: ## –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
	docker-compose exec app npx prisma migrate deploy

db-reset: ## –°–±—Ä–æ—Å–∏—Ç—å –ë–î
	docker-compose exec app npx prisma migrate reset --force

db-studio: ## –û—Ç–∫—Ä—ã—Ç—å Prisma Studio
	docker-compose exec app npx prisma studio

db-shell: ## –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ PostgreSQL
	docker-compose exec postgres psql -U parser -d parsing

# ============================================
# –£–¢–ò–õ–ò–¢–´
# ============================================

shell: ## –ó–∞–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
	docker-compose exec app sh

worker-shell: ## –ó–∞–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä worker
	docker-compose exec worker sh

redis-cli: ## Redis CLI
	docker-compose exec redis redis-cli -a redis123

clean: ## –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ volumes
	@echo "üóëÔ∏è  –û—á–∏—Å—Ç–∫–∞..."
	docker-compose down -v
	@echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"

clean-all: ## –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–≤–∫–ª—é—á–∞—è –æ–±—Ä–∞–∑—ã)
	@echo "üóëÔ∏è  –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞..."
	docker-compose down -v --rmi all
	@echo "‚úÖ –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"

# ============================================
# –ú–û–ù–ò–¢–û–†–ò–ù–ì
# ============================================

stats: ## –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
	docker stats

health: ## –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–≤–∏—Å–æ–≤
	@echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–æ–≤..."
	@curl -s http://localhost:3000/health | jq . || echo "‚ùå API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"

# ============================================
# –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï
# ============================================

test: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
	docker-compose exec app npm test

lint: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–∏–Ω—Ç–µ—Ä
	docker-compose exec app npm run lint

# ============================================
# BACKUP
# ============================================

backup-db: ## –ë—ç–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
	@echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –ë–î..."
	@mkdir -p backups
	docker-compose exec -T postgres pg_dump -U parser parsing > backups/backup_$$(date +%Y%m%d_%H%M%S).sql
	@echo "‚úÖ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω –≤ –ø–∞–ø–∫–µ backups/"

restore-db: ## –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ë–î –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±—ç–∫–∞–ø–∞
	@echo "‚ö†Ô∏è  –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î –∏–∑ –±—ç–∫–∞–ø–∞..."
	@LATEST=$$(ls -t backups/*.sql | head -1); \
	docker-compose exec -T postgres psql -U parser parsing < $$LATEST
	@echo "‚úÖ –ë–î –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!"
