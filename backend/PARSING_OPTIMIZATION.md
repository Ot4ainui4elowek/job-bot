# –£–ª—É—á—à–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞: –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ ParseLog

## –ü—Ä–æ–±–ª–µ–º–∞

–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –≤–∞–∫–∞–Ω—Å–∏–π –≤ –ë–î:

```
1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ë–î ‚Üí 0 –≤–∞–∫–∞–Ω—Å–∏–π
2. ‚Üí –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥ (–¥–∞–∂–µ –µ—Å–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥ –±—ã–ª 5 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥!)
```

–≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫:
- –õ–∏—à–Ω–∏–º –∑–∞–ø—Ä–æ—Å–∞–º –∫ —Å–∞–π—Ç–∞–º
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º –∏–∑-–∑–∞ —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ü–æ–≤—Ç–æ—Ä–Ω–æ–º—É –ø–∞—Ä—Å–∏–Ω–≥—É "–ø—É—Å—Ç—ã—Ö" –∑–∞–ø—Ä–æ—Å–æ–≤ (–∫–æ—Ç–æ—Ä—ã–µ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—Ö–æ–¥—è—Ç)

## –†–µ—à–µ–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ü–ï–†–í–û–ô

–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –≤ `src/shared/managers/vacancyManager.ts`:

```typescript
private async shouldParse(
  sources: string[],
  searchQuery: string,
  filters: SearchFilters
): Promise<{ shouldParse: boolean; reason: string }> {
  // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã ParseLog
  const parseHistory = await Promise.all(
    sources.map(async (source) => {
      const lastParse = await prisma.parseLog.findFirst({
        where: { 
          source, 
          searchQuery,
          status: 'success',
          createdAt: { 
            gte: new Date(Date.now() - this.STALE_THRESHOLD) // –∑–∞ 12 —á–∞—Å–æ–≤
          }
        },
        orderBy: { createdAt: 'desc' },
        select: { 
          createdAt: true,
          vacanciesFound: true,
          vacanciesNew: true
        }
      });

      return {
        source,
        lastParse: lastParse?.createdAt || null,
        wasRecentlyParsed: !!lastParse,
        vacanciesFound: lastParse?.vacanciesFound || 0
      };
    })
  );

  // 2. –ï—Å–ª–∏ –í–°–ï –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–∞—Ä—Å–∏–ª–∏—Å—å –Ω–µ–¥–∞–≤–Ω–æ (< 12 —á–∞—Å–æ–≤)
  const allRecent = parseHistory.every(h => h.wasRecentlyParsed);
  
  if (allRecent) {
    // –°–ª—É—á–∞–π –ê: –Ω–µ–¥–∞–≤–Ω–∏–π –ø–∞—Ä—Å–∏–Ω–≥ –≤–µ—Ä–Ω—É–ª 0 –≤–∞–∫–∞–Ω—Å–∏–π ‚Üí –Ω–µ –ø–∞—Ä—Å–∏–º —Å–Ω–æ–≤–∞
    const allEmpty = parseHistory.every(h => h.vacanciesFound === 0);
    if (allEmpty) {
      return { 
        shouldParse: false, 
        reason: '–ù–µ–¥–∞–≤–Ω–∏–π –ø–∞—Ä—Å–∏–Ω–≥ –≤–µ—Ä–Ω—É–ª 0 –≤–∞–∫–∞–Ω—Å–∏–π –¥–ª—è –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤' 
      };
    }
    
    // –°–ª—É—á–∞–π –ë: –±—ã–ª–∏ –Ω–∞–π–¥–µ–Ω—ã –≤–∞–∫–∞–Ω—Å–∏–∏ ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –≤ –ë–î
    const vacanciesInDb = await vacancyService.findByFilters({
      ...filters,
      sources,
      workLocationType: filters.workLocationType,
      limit: 1,
      page: undefined
    });

    // –ï—Å–ª–∏ –≤–∞–∫–∞–Ω—Å–∏–∏ –µ—Å—Ç—å –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º ‚Üí –Ω–µ –ø–∞—Ä—Å–∏–º
    if (vacanciesInDb.length > 0) {
      return { 
        shouldParse: false,
        reason: `–ù–∞–π–¥–µ–Ω—ã –≤–∞–∫–∞–Ω—Å–∏–∏ –≤ –ë–î (${vacanciesInDb.length}) –ø–æ —Ç–µ–∫—É—â–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º`
      };
    }
    
    // –ï—Å–ª–∏ –≤–∞–∫–∞–Ω—Å–∏–π –Ω–µ—Ç –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º, –Ω–æ –ø–∞—Ä—Å–∏–Ω–≥ –±—ã–ª —É—Å–ø–µ—à–Ω—ã–º ‚Üí –ø–∞—Ä—Å–∏–º
    return { 
      shouldParse: true,
      reason: '–í–∞–∫–∞–Ω—Å–∏–∏ –≤ –ë–î –µ—Å—Ç—å, –Ω–æ –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç —Ç–µ–∫—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã'
    };
  }

  // 3. –ï—Å–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ –Ω–µ –±—ã–ª–æ –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–ª (> 12 —á–∞—Å–æ–≤) ‚Üí –ø–∞—Ä—Å–∏–º
  const neverParsed = parseHistory.filter(h => !h.lastParse);
  if (neverParsed.length > 0) {
    return { 
      shouldParse: true, 
      reason: `–ü–∞—Ä—Å–∏–Ω–≥ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª—Å—è –¥–ª—è: ${neverParsed.map(h => h.source).join(', ')}`
    };
  }

  const oldParses = parseHistory.filter(h => !h.wasRecentlyParsed);
  return { 
    shouldParse: true, 
    reason: `–ü–∞—Ä—Å–∏–Ω–≥ —É—Å—Ç–∞—Ä–µ–ª (> 12 —á–∞—Å–æ–≤) –¥–ª—è: ${oldParses.map(h => h.source).join(', ')}`
  };
}
```

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –º–µ—Ç–æ–¥ `searchRegular`

–ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é –ª–æ–≥–∏–∫—É –≤ `searchRegular`:

```typescript
// === –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–∂–Ω–æ –ª–∏ –ø–∞—Ä—Å–∏—Ç—å –î–û –ø—Ä–æ–≤–µ—Ä–∫–∏ –ë–î ===
const parseDecision = await this.shouldParse(sources, searchQuery, filters);

console.log(`üîç –†–µ—à–µ–Ω–∏–µ –æ –ø–∞—Ä—Å–∏–Ω–≥–µ: ${parseDecision.shouldParse ? '–î–ê' : '–ù–ï–¢'}`);
console.log(`   –ü—Ä–∏—á–∏–Ω–∞: ${parseDecision.reason}`);

if (!parseDecision.shouldParse) {
  // –ü—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î –±–µ–∑ –ø–∞—Ä—Å–∏–Ω–≥–∞
  const allVacancies = await vacancyService.findByFilters({
    ...filters,
    sources,
    workLocationType: filters.workLocationType,
    limit: undefined,
    page: undefined
  });

  console.log(`üìä –ù–∞–π–¥–µ–Ω–æ –≤ –ë–î: ${allVacancies.length} –≤–∞–∫–∞–Ω—Å–∏–π (–±–µ–∑ –ø–∞—Ä—Å–∏–Ω–≥–∞)`);
  
  // –ö—ç—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
  if (userId && allVacancies.length > 0) {
    const cacheKey = cacheService.generateKey(userId, filters);
    const typedVacancies = allVacancies.map(mapPrismaToVacancy);
    await cacheService.cacheSearchResults(cacheKey, typedVacancies, filters);
  }

  // –í—ã—á–∏—Å–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
  const total = allVacancies.length;
  const totalPages = Math.ceil(total / limit);
  const offset = (page - 1) * limit;
  const vacancies = allVacancies.slice(offset, offset + limit);

  const lastUpdate = parseHistory.reduce((latest, p) => {
    if (!p.lastParse) return latest;
    return !latest || p.lastParse > latest ? p.lastParse : latest;
  }, null as Date | null);

  return {
    vacancies: vacancies.map(mapPrismaToVacancy),
    meta: {
      total,
      totalPages,
      source: 'cache',
      lastUpdate,
      updating: false,
      parseReason: parseDecision.reason
    }
  };
}

// === –°–¢–ê–†–ê–Ø –õ–û–ì–ò–ö–ê: –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–∞—Ä—Å–∏—Ç—å ===
// ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –ø–∞—Ä—Å–∏–Ω–≥–∞
```

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ

| –°—Ü–µ–Ω–∞—Ä–∏–π | –†–µ—à–µ–Ω–∏–µ | –ü—Ä–∏—á–∏–Ω–∞ |
|----------|---------|---------|
| –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å "–£–±–æ—Ä—â–∏—Ü–∞" | ‚úÖ –ü–∞—Ä—Å–∏–º | –ü–∞—Ä—Å–∏–Ω–≥–∞ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—ã–ª–æ |
| –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å "–£–±–æ—Ä—â–∏—Ü–∞" —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç | ‚ùå –ù–µ –ø–∞—Ä—Å–∏–º | –ü–∞—Ä—Å–∏–Ω–≥ –±—ã–ª –Ω–µ–¥–∞–≤–Ω–æ –∏ –≤–µ—Ä–Ω—É–ª 395 –≤–∞–∫–∞–Ω—Å–∏–π |
| –ó–∞–ø—Ä–æ—Å "–ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è–ü—Ä–æ—Ñ–µ—Å—Å–∏—è123" | ‚úÖ –ü–∞—Ä—Å–∏–º –ø–µ—Ä–≤—ã–π —Ä–∞–∑ ‚Üí ‚ùå –ù–µ –ø–∞—Ä—Å–∏–º –ø–æ–≤—Ç–æ—Ä–Ω–æ | –ü–µ—Ä–≤—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –≤–µ—Ä–Ω—É–ª 0 ‚Üí –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –∏ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ–º |
| –ó–∞–ø—Ä–æ—Å —Å —Ñ–∏–ª—å—Ç—Ä–æ–º `salaryMin=1000000` | ‚ùå –ù–µ –ø–∞—Ä—Å–∏–º (–µ—Å–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥ –±—ã–ª –Ω–µ–¥–∞–≤–Ω–æ) | –í –ë–î –µ—Å—Ç—å –≤–∞–∫–∞–Ω—Å–∏–∏, –Ω–æ –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç —Ñ–∏–ª—å—Ç—Ä ‚Üí –Ω–µ —Ç—Ä–∞—Ç–∏–º —Ä–µ—Å—É—Ä—Å—ã |

## –í–∞–∂–Ω–æ: —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É `searchBy=title` –∏ `useSemanticSearch`

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç | –ö–æ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è |
|----------|------------|-------------------|
| `searchBy=title` | –ò—â–µ—Ç –≤ –ë–î –ø–æ –ø–æ–ª—è–º `title` **–ò–õ–ò** `category` (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π) | –û–±—ã—á–Ω—ã–π –ø–æ–∏—Å–∫. **–ù–µ** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ª–æ–≤–∞—Ä–∏–∫–∏ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞. |
| `searchBy=category` | –ò—â–µ—Ç –≤ –ë–î —Ç–æ–ª—å–∫–æ –ø–æ –ø–æ–ª—é `category` | –ü–æ–∏—Å–∫ –ø–æ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–º—É –Ω–∞–∑–≤–∞–Ω–∏—é –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ |
| `useSemanticSearch=true` | 1. –î–µ–ª–∞–µ—Ç —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –º–∞–ø–ø–∏–Ω–≥ —á–µ—Ä–µ–∑ —Å–ª–æ–≤–∞—Ä–∏–∫–∏ ‚Üí 2. –ü–∞—Ä—Å–∏—Ç —Å –¢–û–ß–ù–´–ú–ò –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –∏–∑ `sourceMappings` ‚Üí 3. –ò—â–µ—Ç –≤ –ë–î –ø–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É | –¢–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–∞—Ä—Å–∏–Ω–≥–µ –∏–ª–∏ –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –≤ –ë–î |

**–ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç:** –ú–µ—Ö–∞–Ω–∏–∑–º `determineCategory()` (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–≥–æ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞) —Ä–∞–±–æ—Ç–∞–µ—Ç **–ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤–∞–∫–∞–Ω—Å–∏–π**, –∞ –Ω–µ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ:

- –ü—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ ‚Üí –≤–∞–∫–∞–Ω—Å–∏—è –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–µ `category = "–£–±–æ—Ä—â–∏—Ü–∞"`
- –ü—Ä–∏ –ø–æ–∏—Å–∫–µ —Å `searchBy=title&keywords=–£–±–æ—Ä—â–∏—Ü–∞` ‚Üí –∏—â–µ—Ç –≤ `title` –ò–õ–ò `category`
- –ü—Ä–∏ –ø–æ–∏—Å–∫–µ —Å `useSemanticSearch=true&keywords=cleaner` ‚Üí –º–∞–ø–ø–∏—Ç "cleaner" ‚Üí "–£–±–æ—Ä—â–∏—Ü–∞" ‚Üí –ø–∞—Ä—Å–∏—Ç —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –∏–∑ `sourceMappings` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞

## –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ –§–∏–ª—å—Ç—Ä `workLocationType` –∏—Å–ø—Ä–∞–≤–ª–µ–Ω (–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è 'abroad' ‚Üí '–ó–∞ –≥—Ä–∞–Ω–∏—Ü–µ–π')  
‚úÖ –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º —Ç–µ–ø–µ—Ä—å –∏—â–µ—Ç –≤ `title` –ò–õ–ò `category`  
‚úÖ –õ–æ–≥–∏–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —É–ª—É—á—à–µ–Ω–∞: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑ `ParseLog` –ü–ï–†–í–û–ô  
‚úÖ –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ `useSemanticSearch=true`  
‚úÖ –ò–∑–±–µ–≥–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ "–ø—É—Å—Ç—ã—Ö" –∑–∞–ø—Ä–æ—Å–æ–≤  

## –ß—Ç–æ –¥–µ–ª–∞—Ç—å

1. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `shouldParse` –≤ `vacancyManager.ts`
2. –ó–∞–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É –≤ `searchRegular` –Ω–∞ –Ω–æ–≤—É—é
3. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç: `npm run build`
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä: `npm run start`

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∑–∞–ø—Ä–æ—Å—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –∞ –ø–∞—Ä—Å–∏–Ω–≥ –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ.
